// Source: https://wiki.zeteco.ch/wiki/Badge#Be_excellent_.28to_each_other.29

#include <avr/pgmspace.h>

/*
 * Copyleft 2017 by Ivo Blöchliger, vorname@bloechligair.ch
 */

/*
 * 8kHz samplerate, runlength encoded (255,x means x times 127)
 */

const unsigned char samples[] PROGMEM = {
130,127,127,133,124,127,130,122,255,4,131,131,133,137,139,141,144,147,149,152,155,143,153,156,145,141,135,132,127,121,116,111,108,107,104,102,101,103,
110,106,108,106,120,119,113,119,127,131,127,130,127,134,138,132,127,136,133,130,127,127,130,132,127,122,127,130,255,4,130,127,127,124,127,121,121,124,120,119,
120,122,122,122,127,127,137,135,134,137,165,151,147,155,170,161,161,145,149,164,147,106,133,137,104,91,114,104,92,83,96,112,102,97,105,130,115,118,130,135,
130,136,136,138,136,133,138,127,131,127,133,123,122,255,6,130,131,127,130,130,130,255,4,122,117,121,118,117,114,116,122,123,115,131,141,127,136,160,148,150,
160,158,168,142,150,160,139,103,154,109,96,108,109,85,98,96,107,101,101,127,118,116,138,136,127,142,140,138,137,137,135,130,127,130,123,123,124,122,121,122,
124,124,127,127,130,130,132,133,134,132,130,132,127,124,124,123,117,117,114,119,110,113,127,115,117,143,127,135,154,148,154,151,167,153,140,157,149,98,158,100,
100,114,98,89,104,101,106,102,127,123,114,146,132,133,148,141,137,142,137,135,127,133,127,122,124,121,118,121,121,121,122,255,3,131,133,134,133,136,136,131,
131,133,122,124,122,116,112,111,117,103,112,124,110,120,151,118,154,156,157,158,166,172,149,144,178,104,131,144,76,111,103,81,88,95,96,95,100,137,99,139,
143,131,145,153,140,146,144,142,132,132,134,119,124,122,116,117,119,118,119,122,127,127,130,134,136,136,136,139,136,130,134,130,117,127,115,111,107,112,106,101,
117,123,99,149,134,130,168,157,163,164,182,166,151,164,170,76,180,82,92,103,86,71,88,90,96,83,127,117,104,158,130,140,155,151,145,149,148,142,127,141,
124,119,124,116,112,115,116,116,118,124,127,127,135,139,140,139,144,142,133,134,137,112,123,116,101,103,103,102,92,107,123,97,134,160,114,183,170,174,177,197,
183,166,153,206,56,175,102,64,101,81,59,71,80,85,70,104,133,77,165,133,143,157,165,152,155,156,153,127,144,130,114,122,114,107,110,113,112,114,123,127,
127,137,142,141,142,147,143,134,136,136,108,124,111,95,100,101,92,92,104,127,87,150,154,119,194,174,178,187,206,184,171,161,210,39,203,70,73,89,74,50,
63,78,82,60,117,122,81,173,127,149,159,166,154,155,160,150,127,148,124,115,123,112,107,111,113,112,115,255,3,140,143,142,145,149,142,131,141,127,107,124,
104,94,98,101,88,96,106,127,79,180,127,145,188,173,174,189,198,179,157,185,173,57,219,34,107,81,73,50,72,79,77,68,136,97,110,170,120,157,159,159,
150,156,156,139,135,144,116,121,122,109,110,114,113,114,119,127,127,131,137,140,140,140,144,140,127,139,127,112,123,109,101,103,107,98,99,116,127,89,175,120,
150,175,167,165,179,182,172,141,189,142,85,198,42,120,85,81,65,86,87,84,87,137,95,127,160,115,159,150,151,145,153,146,135,137,137,117,127,121,111,117,
116,114,119,122,124,127,132,134,139,140,137,141,141,127,137,127,113,121,113,103,105,108,105,96,120,127,91,172,122,147,171,165,162,176,176,171,134,192,127,94,
191,43,127,86,83,71,91,90,87,96,135,96,131,157,112,163,144,148,143,151,141,134,138,133,117,127,120,113,120,117,116,121,123,124,127,131,132,137,137,133,
139,135,127,136,122,118,121,116,106,113,109,114,95,144,98,127,151,124,153,162,159,156,174,162,160,127,201,62,170,109,82,121,92,88,93,101,95,96,116,123,
97,156,119,134,152,136,142,146,141,135,137,136,255,3,118,123,123,119,123,127,124,127,131,127,133,134,127,134,132,123,127,123,116,116,120,108,111,118,116,101,
151,102,142,146,136,151,160,159,150,169,161,145,138,184,61,188,84,104,117,93,88,104,97,94,105,113,112,106,150,103,145,139,127,142,144,133,140,139,132,133,
134,127,127,131,124,255,4,130,127,127,130,124,127,127,121,120,122,118,112,122,116,112,127,124,108,151,115,142,144,143,145,155,157,143,159,156,138,137,168,77,
174,92,111,120,99,97,112,100,100,110,110,112,110,138,104,141,130,127,140,137,131,141,136,132,136,134,130,132,132,127,130,255,4,124,127,127,121,123,122,119,
118,122,115,117,127,115,119,134,116,131,141,123,149,140,147,144,157,146,145,155,147,124,165,116,121,151,87,131,110,99,108,110,98,110,109,114,108,127,117,118,
138,120,132,137,127,135,138,130,135,135,131,132,134,127,127,131,255,255,127,255,255,127,255,255,127,255,42,130,127,130,131,127,130,123,121,127,127,114,127,134,
139,139,132,137,140,108,98,131,122,132,141,165,179,168,109,137,123,76,74,100,113,131,127,135,164,131,111,120,120,111,118,119,135,138,127,131,135,127,124,127,
122,127,124,124,127,131,130,132,132,127,132,120,119,127,123,108,132,136,146,143,135,145,144,91,88,135,117,138,150,191,207,180,95,151,110,47,47,90,106,135,
121,145,182,127,103,117,115,102,115,115,142,141,127,134,139,127,123,124,121,123,123,123,127,131,131,132,133,127,132,127,115,123,127,108,122,139,143,151,137,140,
153,109,70,123,127,127,151,180,219,210,118,122,147,48,34,67,101,124,132,127,187,154,100,111,117,102,108,114,130,150,127,131,141,131,120,127,121,121,121,122,
127,130,133,134,135,132,127,135,115,113,127,121,97,136,142,159,153,140,156,153,65,66,140,111,148,166,234,252,205,75,168,91,0,6,75,96,141,116,160,209,
122,91,112,107,89,110,110,152,145,127,138,146,122,122,124,118,119,119,122,127,132,134,135,136,130,132,131,109,117,127,107,105,145,145,166,146,144,166,127,39,
99,137,115,163,190,254,250,152,93,177,40,0,28,90,110,142,115,195,185,97,100,115,98,94,111,121,161,132,127,144,139,117,127,120,118,119,120,124,130,135,
137,138,137,127,139,118,104,121,127,86,127,148,164,169,144,157,174,71,25,134,115,138,174,245,254,229,91,144,127,9,0,59,92,132,127,139,211,144,89,109,
112,91,106,110,141,153,127,135,146,127,120,127,119,119,120,122,127,130,133,134,135,131,130,134,114,115,127,118,101,139,141,159,147,139,156,145,64,81,140,113,
150,165,229,241,186,80,171,80,13,19,85,101,141,115,166,196,115,96,114,108,94,113,114,152,139,127,138,141,121,124,123,120,120,120,124,127,131,135,136,135,
131,131,134,110,114,127,113,97,142,143,165,151,142,163,143,49,78,142,111,156,174,251,252,185,78,177,69,2,12,84,100,143,112,176,199,110,94,114,104,92,
112,115,157,138,127,140,143,120,127,122,120,119,117,124,127,127,135,135,133,133,127,135,119,113,124,127,98,127,140,153,154,139,149,158,87,61,134,118,136,158,
207,239,214,92,145,124,24,16,71,98,132,124,141,198,138,94,113,113,97,110,114,142,147,127,134,141,127,122,127,122,122,119,122,127,127,131,137,133,133,131,
130,134,115,116,127,118,100,136,140,157,148,139,155,144,68,84,140,114,149,162,222,230,179,85,167,83,26,33,90,104,139,116,163,185,115,101,116,109,100,116,
118,150,137,127,137,138,122,127,124,122,122,119,124,127,127,131,134,131,131,127,130,131,118,120,127,118,110,135,136,148,140,136,148,133,83,105,134,119,145,154,
193,195,151,103,155,88,61,70,106,115,135,120,157,159,114,112,120,114,110,121,124,143,131,127,134,133,123,127,127,124,124,123,255,3,130,132,131,131,127,130,
127,122,121,123,121,127,124,133,151,138,130,140,127,103,110,116,134,147,142,175,182,139,114,144,91,73,97,117,104,131,145,141,136,127,122,118,113,116,255,3,
135,132,255,6,124,255,255,127,255,33,130,130,127,130,255,5,130,127,127,130,130,131,130,130,130,131,255,3,132,132,127,100,133,255,3,139,136,127,134,135,
131,132,137,131,127,127,131,255,4,112,134,255,3,134,133,127,133,132,255,3,130,255,6,130,131,132,131,130,134,131,131,132,255,6,130,130,131,132,132,135,
130,132,130,132,255,9,131,127,130,130,127,131,127,131,127,127,130,127,130,127,127,130,127,131,127,132,130,130,131,127,131,127,130,127,130,131,130,131,132,131,
127,131,131,127,131,127,127,130,127,132,130,131,134,127,134,130,127,130,130,127,130,132,132,127,132,130,255,8,130,131,130,130,127,130,255,3,130,127,132,131,
133,134,127,135,131,131,132,127,132,127,130,130,127,130,127,131,130,127,131,132,127,130,132,127,127,130,255,3,130,127,127,130,130,132,130,132,132,127,131,127,
130,255,8,131,127,127,132,127,131,130,127,127,130,255,3,131,130,127,130,127,131,130,130,127,132,127,127,130,255,7,131,130,130,131,131,255,6,130,130,130,
132,131,134,127,127,130,255,3,132,130,127,132,131,130,131,130,132,255,8,130,131,127,131,130,127,131,131,131,130,131,130,127,130,255,7,130,255,5,133,127,
137,143,127,127,116,139,127,122,139,118,127,139,122,131,136,132,133,143,143,127,127,130,134,138,132,133,133,127,133,141,133,127,123,127,113,135,134,127,144,127,
131,138,122,134,132,109,137,116,127,139,127,131,139,127,119,140,134,127,131,127,117,255,4,130,141,127,132,137,127,127,131,130,143,127,127,131,120,119,115,137,
122,122,127,127,132,155,127,119,123,114,124,138,136,127,130,131,122,131,130,133,116,127,134,116,130,144,131,146,138,123,133,127,137,143,138,123,130,133,134,255,
3,124,127,137,121,127,137,127,123,124,122,124,127,115,134,130,114,135,140,127,127,131,121,124,132,135,123,112,134,107,122,154,121,127,141,127,127,148,137,111,
127,137,123,137,120,106,127,119,114,131,127,116,145,127,119,134,113,131,130,127,124,141,127,127,138,123,118,117,148,136,137,142,122,137,141,136,147,132,133,140,
121,132,138,121,143,127,133,133,121,117,132,143,137,141,127,136,131,130,127,142,127,132,142,134,117,124,137,130,121,134,147,140,141,114,108,127,113,121,127,124,
123,120,122,110,139,142,135,145,127,120,127,147,131,127,150,130,124,141,133,105,122,141,113,145,142,110,127,145,118,130,127,130,121,134,137,114,134,131,132,136,
97,139,134,117,137,145,124,118,119,114,127,141,133,117,117,113,121,122,132,127,120,133,119,137,132,140,138,140,143,150,132,93,140,127,127,156,133,127,157,109,
127,130,112,127,132,140,137,137,145,127,141,148,127,151,131,133,136,136,109,133,127,132,157,157,122,179,150,110,147,93,118,147,124,140,150,155,117,137,137,92,
127,111,124,127,113,121,127,136,121,121,139,133,135,101,99,132,115,124,147,132,120,147,121,111,150,134,138,151,140,127,127,153,140,127,124,130,105,127,149,131,
144,127,98,127,127,119,137,143,144,134,114,132,127,127,131,163,133,130,144,122,117,127,123,134,145,132,150,152,136,140,131,137,145,133,140,127,114,110,127,136,
143,142,152,138,139,154,164,127,122,127,106,120,135,108,120,127,117,130,122,109,133,177,132,176,182,115,127,137,121,117,138,144,130,149,130,127,144,152,138,124,
143,114,100,123,108,155,161,106,158,143,131,134,138,124,114,141,157,159,115,114,97,104,121,156,133,124,132,127,112,133,140,112,111,133,134,109,123,148,149,118,
155,154,127,127,141,143,116,130,127,100,127,130,255,5,124,122,127,130,127,127,132,141,140,136,130,127,131,127,114,111,127,137,134,141,146,165,161,148,121,127,
127,102,88,90,108,115,121,116,127,149,143,127,121,127,122,118,110,110,121,127,127,123,130,133,132,127,124,255,3,123,124,127,131,131,127,127,131,130,124,120,
121,127,132,127,127,139,155,147,136,133,133,138,120,100,97,133,148,131,146,161,196,191,166,118,127,141,91,62,52,89,106,123,103,117,159,161,139,114,118,117,
121,103,91,109,127,130,123,127,131,138,134,123,120,124,127,123,121,123,130,133,132,127,127,134,133,123,115,120,255,3,122,142,160,166,134,137,142,146,127,95,
80,113,162,146,127,173,203,245,197,156,90,156,108,58,8,36,72,122,118,88,133,179,171,138,105,104,112,127,85,86,102,131,133,131,122,130,142,136,123,117,
121,127,127,121,121,127,134,133,127,127,135,139,131,117,111,127,135,120,116,123,156,177,176,136,135,172,158,122,70,66,106,180,157,110,192,240,254,203,163,78,
154,120,66,6,25,64,123,134,91,120,165,172,154,112,97,104,132,99,95,96,122,134,139,123,124,134,136,127,121,119,123,127,127,123,124,127,131,130,127,127,
132,134,130,123,119,123,132,127,117,127,136,156,153,145,123,152,148,135,100,93,103,141,152,116,140,176,209,199,165,116,122,151,95,67,43,78,105,139,106,109,
145,157,154,123,111,104,130,115,105,102,118,127,136,127,123,130,134,130,124,122,123,255,6,130,255,3,131,133,127,123,121,124,130,127,120,127,138,151,145,140,
124,144,140,127,102,104,113,137,145,122,141,165,186,170,152,117,127,136,104,86,73,92,114,130,111,121,136,148,151,133,120,121,127,119,116,106,114,122,255,4,
133,134,130,255,5,124,127,127,130,255,6,122,123,127,130,130,130,133,138,140,135,127,127,124,127,119,113,112,127,127,137,134,137,149,153,150,139,132,127,130,
116,112,103,107,113,120,117,122,124,133,137,135,132,132,133,134,131,255,4,124,122,121,123,255,19,132,134,133,131,130,130,131,127,124,118,119,120,122,118,121,
121,133,136,140,140,141,149,151,147,138,133,127,132,116,115,103,106,110,117,113,119,118,132,136,138,135,134,134,138,133,127,123,121,123,122,121,119,121,124,255,
5,130,255,6,124,255,5,130,133,136,133,132,133,134,135,127,123,117,121,119,121,109,118,115,136,136,140,141,145,155,161,152,141,132,124,133,111,111,92,99,
105,116,113,121,115,138,138,148,138,135,134,137,133,127,118,117,119,121,123,118,120,123,127,130,255,3,130,130,255,5,124,255,4,124,127,131,134,135,132,133,
138,139,139,127,122,118,123,117,118,98,115,110,138,133,139,138,151,160,175,152,146,127,124,135,105,109,77,94,100,118,116,123,115,145,141,160,139,137,127,134,
132,127,115,112,113,120,123,122,122,122,127,132,133,131,255,3,130,255,8,123,121,122,127,132,131,133,131,138,145,147,141,131,123,127,122,123,108,94,112,114,
143,135,136,138,160,166,192,133,159,96,147,114,111,86,63,93,97,120,112,111,114,152,141,166,121,132,119,127,123,104,101,98,112,119,127,122,127,132,139,137,
132,255,3,124,122,122,127,130,133,133,132,130,131,127,121,114,111,116,124,131,127,135,141,161,167,157,140,134,131,142,121,95,94,85,147,139,148,139,151,194,
226,181,166,118,117,161,86,88,26,53,97,122,102,116,110,158,181,148,137,106,117,121,113,84,91,93,120,255,3,134,142,143,135,127,124,123,123,120,119,122,
255,3,131,134,134,131,130,130,133,127,119,113,114,127,130,124,123,137,152,177,158,140,140,139,154,127,87,69,115,127,169,143,127,202,238,249,187,153,84,180,
92,66,0,26,60,134,105,84,132,152,187,156,113,87,121,115,99,87,85,115,139,136,123,127,136,139,131,117,115,121,127,124,127,127,132,132,255,3,124,122,
127,127,132,127,127,137,140,134,121,114,122,136,127,111,122,141,175,172,157,120,168,164,142,82,67,81,147,171,111,145,211,254,233,182,122,112,169,86,51,6,
54,87,142,99,95,149,170,168,127,104,91,127,113,94,91,111,130,138,127,120,130,137,131,122,117,121,127,127,123,124,127,131,131,255,5,123,127,127,131,130,
127,130,135,135,127,120,120,127,134,120,118,127,148,158,155,130,136,158,145,118,89,91,119,159,141,119,173,196,232,182,154,89,154,114,78,29,48,76,127,127,
97,127,161,166,146,113,100,110,127,103,99,104,127,134,136,123,124,133,133,127,121,120,124,127,127,124,127,127,130,255,10,131,127,127,131,134,134,127,121,122,
130,131,118,120,127,150,154,150,127,142,154,140,111,91,96,127,155,127,127,174,197,219,171,143,100,161,105,81,37,67,87,133,115,101,134,156,159,134,117,105,
123,124,106,104,112,127,130,130,122,127,133,131,127,123,124,255,22,130,127,124,124,127,131,255,3,138,140,138,255,4,122,118,120,133,145,145,147,156,158,163,
150,144,122,133,111,106,95,97,94,96,95,104,111,110,117,124,255,4,130,255,10,130,130,255,22,124,255,14,130,130,136,144,145,148,160,161,162,161,158,154,
146,127,127,116,104,97,97,92,95,93,100,109,108,114,121,255,4,130,255,7,130,127,127,130,131,255,23,124,255,14,131,130,137,144,146,149,160,161,162,161,
158,154,146,127,127,116,104,97,97,92,95,93,99,109,108,114,121,124,124,127,127,130,255,3,130,127,127,130,130,130,127,130,130,255,18,130,255,5,124,124,
127,124,123,124,127,127,124,255,3,124,127,127,131,130,134,142,147,146,156,162,160,163,158,158,151,138,127,127,108,100,96,93,92,92,94,105,108,110,117,124,
123,127,127,130,255,3,131,127,127,130,131,131,130,130,131,255,5,123,123,124,124,124,255,5,130,131,131,131,131,131,130,255,4,124,124,124,123,123,124,127,
127,123,255,6,131,130,137,144,146,149,159,160,160,160,157,153,146,127,127,117,105,98,98,94,97,95,101,110,109,114,121,124,124,127,127,130,127,127,130,131,
127,130,131,132,131,130,131,131,255,4,124,123,123,124,124,124,255,5,130,131,131,131,131,131,130,255,4,124,124,124,123,123,124,127,127,124,255,6,130,130,
135,141,143,144,153,154,154,154,151,149,143,130,127,121,110,104,104,101,102,101,105,113,112,115,121,127,124,127,127,130,255,3,130,127,127,130,131,131,130,130,
130,255,5,124,124,124,124,124,255,6,130,130,130,130,131,130,255,7,124,123,124,127,127,124,255,7,130,131,136,140,139,144,149,148,149,147,147,142,135,127,
127,116,111,108,107,106,107,106,113,116,116,120,124,255,7,130,255,3,130,131,130,255,8,124,124,255,255,127,255,36,130,255,4,123,127,123,127,135,133,133,
122,130,131,135,133,134,136,127,132,137,135,138,136,134,131,124,255,5,133,130,133,136,136,127,131,130,131,130,132,130,131,131,127,132,127,132,134,127,133,132,
130,135,124,124,127,121,127,130,136,127,130,127,132,127,123,127,131,137,131,130,127,132,127,131,132,133,127,135,127,131,132,127,136,135,133,124,136,135,131,134,
255,5,124,124,136,139,139,133,255,6,136,122,124,130,141,130,255,3,124,133,138,136,127,127,136,137,135,138,136,255,3,130,119,136,130,127,133,127,124,138,
127,131,141,131,118,127,133,119,127,137,123,117,136,127,124,134,136,127,135,132,127,130,127,127,122,127,127,133,255,3,132,122,255,3,130,124,135,132,132,127,
135,140,127,133,145,133,127,135,130,137,127,123,131,130,127,131,140,139,122,133,145,127,117,133,145,122,118,135,130,127,122,131,127,127,135,136,130,255,3,123,
139,124,122,136,133,124,131,137,131,135,121,132,127,127,124,255,4,131,127,131,136,127,135,127,131,131,132,123,127,127,134,131,131,132,130,127,131,127,132,134,
130,130,133,130,127,122,127,127,130,124,127,134,127,127,131,127,127,132,130,127,140,255,4,124,130,135,133,127,131,130,127,131,131,127,123,127,123,135,127,135,
127,133,130,130,127,132,131,255,3,133,127,133,127,130,127,131,255,3,130,134,255,100};

volatile int pos=0;

/*
 * Setting up the timers, Timer 0 62kHz 8bit PWM as carrier
 * Timer 1, 8kHz for interrupt to set duty cycle (and decode rle)
 */

void setup() {
  for (int i=0; i<5; i++) {
    pinMode(i, OUTPUT);
  }
  // Timer 0
  TCCR0A = 0b10000011;  //
  TCCR0B = 0b001;       // No prescaling 62kHz carrier
  OCR0A = 8;            // 0..255 pwm on output OC0A pin  (OC0A is needed!)

  // Timer 1
  cli();

    TCCR1=0;
    TCNT1 = 0;                  //zero the timer
    GTCCR = _BV(PSR1);          //reset the prescaler
    OCR1A=255;           //contador CTC, tiene un tamaño de 2^8-1=255
    OCR1C=255;
    TCCR1 = 0b0100;    // Prescaler 7812Hz
    TIMSK=(1<<OCIE1A); //para habilitar la comparacion Output Compare A Match (vector interrupcion)

    sei();
}

void pwmOn() {
  pos = 0;
  TCCR0A = 0b10000011;
}
void pwmOff() {
  TCCR0A = 0;
}

volatile unsigned char rle=0;
volatile unsigned long myMillis=0;
ISR(TIMER1_COMPA_vect) {
  myMillis++;
  if (TCCR0A) {
    if (rle>0) {
      OCR0A=127;
      rle--;
    } else {
      int v = pgm_read_byte(&(samples[pos]));
      pos++;
      if (v==255) {
        rle = pgm_read_byte(&(samples[pos]));
        pos++;
        OCR0A = 127;
      } else {
        OCR0A = v;
      }
    }
    if (pos>=sizeof(samples)) {
      pos=0;
      pwmOff();
    }
  }
}

/*
 * delay ist not working anymore, so here is myDelay
 */

void myDelay(int ms) {
  ms*=8;
  long start = myMillis;
  while (start+ms-myMillis>0);
}

// returns the button number pressed, or zero for none pressed
int readButtons() {
  int c = analogRead(A0); // get the analog value from ADC0 (on pin 5)
  if (c>600) {
    return 1;
  } else if (c>400) {
    return 2; // button 2 pressed
  } else if (c>300) {
    return 3; // button 3 pressed
  } else if (c>240) {
     return 4; // button 4 pressed
  } else if (c>180) {
     return 5; // button 5 pressed
  } else if (c>160) {
     return 6;  // button 6 pressed
  } else if (c>100) {
    return 7;
  }
  return 0;
}

/*
 * Did not manage (for some unknown reason) to use my software pwm... something fishy in this whole sketch.
 */

void roller() {
  while (true) {
    for (int i=1; i<7; i++) {
      digitalWrite(i>4? 8-i : i, HIGH);
      myDelay(200);
      digitalWrite(i>4? 8-i : i,LOW);
      if (readButtons()!=0) return;
    }
  }
}

void loop() {
  roller();
  pwmOn();
  while(readButtons()!=0) {
    for (int i=0; i<4; i++) {
      digitalWrite(i+1,HIGH);
      myDelay(1);
      digitalWrite(i+1,LOW);
    }
  }
}
